import os
import numpy as np
import pandas as pd
import pyarabic.araby as araby
from ibm_watsonx_ai.foundation_models import Model

def main(sentence, word, irab):
    print(sentence, word, irab)



    def get_credentials():
        return {
            "url": "https://eu-de.ml.cloud.ibm.com",
            "apikey": "vGt-8Abv5RGFaVdJ8OvBibAMOCZCMp1Vgg8kdkn0zbtd"
        }

    model_id = "sdaia/allam-1-13b-instruct"
    parameters = {
        "decoding_method": "greedy",
        "max_new_tokens": 900,
        "repetition_penalty": 1
    }
    project_id = 'c2974d6b-cb61-4859-a34e-e5943a1e919c'

    model = Model(
        model_id=model_id,
        params=parameters,
        credentials=get_credentials(),
        project_id=project_id,
        space_id=None
    )

    def prompt_input():
        cot = """
  <s> [INST]
        الجمله: ما أهملت واجبى قط
        الاعراب: ما : اسم إن منصوب وعلامة نصبه الألف
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]

 1- تحديد نوع الجملة: الجملة المعطاة هي جملة اسمية، لأن الفاعل (ما) ليس اسماً لشخص أو مكان أو زمان، بل هو اسم يفيد العموم والاستغراق (اسم نكرة).

2- تحديد وظيفة الكلمة: في هذه الجملة، الكلمة الرئيسية هي "ما" وتعني النفي.

3- تحديد إعرابها: بناءً على نوع الجملة ووظيفة الكلمة، يمكن تحديد إعراب "ما" كالتالي:
   - ما: اسم نكرة مبني على السكون (اسم نكرة يفيد العموم والاستغراق) في محل رفع مبتدأ.

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى: ما (اسم إن منصوب وعلامة نصبه الألف)
   - الإعراب الصحيح: ما (اسم نكرة مبني على السكون في محل رفع مبتدأ)

الإجابة النهائية: خاطئ

</s>
<s>[INST]
        الجمله: الطائر يطير في السماء
        الاعراب: يطير : فعل مضارع مرفوع وعلامة رفعه الضمة الظاهرة على آخره،والفاعل ضمير مستتر تقديره "هو" يعود على الطائر
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة هي جملة فعلية لأن الفعل الرئيسي فيها هو "يطير" ويتحدث عن حدوث الفعل.

2- تحديد وظيفة الكلمة:
   - الطائر: اسم مرفوع وهو فاعل الفعل "يطير".
   - يطير: فعل مضارع مرفوع.
   - في: حرف جر.
   - السماء: اسم مجرور وعلامة جره الكسرة الظاهرة على آخره.

3- تحديد إعراب الكلمات:
   - الطائر: فاعل مرفوع وعلامة رفعه الضمة الظاهرة على آخره.
   - يطير: فعل مضارع مرفوع وعلامة رفعه الضمة الظاهرة على آخره، والفاعل ضمير مستتر تقديره "هو".
   - في: حرف جر.
   - السماء: اسم مجرور وعلامة جره الكسرة الظاهرة على آخره.

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى يتطابق مع الإعراب الصحيح الذي تم تحديده في الخطوة الثالثة.

الإجابة النهائية: صحيح
</s><s>[INST]
        الجمله: الذي يفوز فله جائزة
        الاعراب: يفوز : فعل مضارع مرفوع،وعلامة رفعه الضمة الظاهرة على آخره
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة تبدو جملة فعلية لأنها تحتوي على فعل (يفوز).

2- تحديد وظيفة الكلمة: في هذه الجملة، الفعل الرئيسي هو "يفوز" والفاعل المستتر تقديره "هو".

3- تحديد إعراب الكلمة:
   - يفوز: فعل مضارع مرفوع، وعلامة رفعه الضمة الظاهرة على آخره. (هذا الإعراب المعطى)

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى: يفوز (فعل مضارع مرفوع، وعلامة رفعه الضمة الظاهرة على آخره)
   - الإعراب الصحيح: يفوز (فعل مضارع مرفوع، وعلامة رفعه الضمة الظاهرة على آخره)

بناءً على المقارنة، يتطابق الإعراب المعطى مع الإعراب الصحيح.

الإجابة النهائية: صحيح
</s><s>[INST]
        الجمله: كل من تلقاه يشكو دهره
        الاعراب: يشكو : فعل مضارع مرفوع وعلامة رفعه الضمة المقدرة على الواو للثقل،والفاعل ضمير مستتر تقديره "هو"
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة تبدو جملة فعلية لأن الفعل الظاهر فيها هو "يشكو".

2- تحديد وظيفة الكلمة: الكلمة المعنية هي "يشكو" وهي فعل مضارع.

3- تحديد إعرابها:
   - يشكو: فعل مضارع مرفوع وعلامة رفعه الضمة المقدرة على الواو للثقل.
   - الفاعل: ضمير مستتر تقديره "هو".

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى يتطابق مع الإعراب الصحيح للفعل المضارع "يشكو" وفاعله المستتر.

الإجابة النهائية: صحيح
</s><s>[INST]
        الجمله: خرج القطار من المحطة
        الاعراب: المحطة : مفعول لأجله مرفوع وعلامة رفعه الضمة
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة هي جملة فعلية، لأنها تبدأ بالفعل خرج (قطار).

2- تحديد وظيفة الكلمة: في هذه الجملة، الكلمة الرئيسية هي "القطار" وهو الفاعل الذي يقوم بالفعل. أما "المحطة" فهي المفعول به الذي يحدث له الفعل.

3- تحديد إعراب الكلمة: في هذه الحالة، يجب أن يكون إعراب "المحطة" هو المفعول به لا المفعول لأجله. المفعول لأجله يأتي لبيان سبب حدوث الفعل، وفي الجملة المعطاة، لا يوجد سبب واضح لخروج القطار من المحطة (مثل الهروب من شيء أو الوصول إلى مكان معين).

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى: المحطة: مفعول لأجله مرفوع وعلامة رفعه الضمة.
   - الإعراب الصحيح: المحطة: مفعول به منصوب وعلامة نصبه الفتحة.

بناءً على التحليل، الإجابة النهائية هي: خاطئ.
</s><s> [INST]
        الجمله: دائما أحب والدى
        الاعراب: والدي : توكيد منصوب وعلامة نصبه الكسرة
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة هي جملة اسمية، لأن الفاعل (والدي) اسم والفعل (أحب) ليس دالا على حدث يقع في زمن محدد.

2- تحديد وظيفة الكلمة: في هذه الجملة، "والدي" هو الفاعل المتصل بالفعل "أحب" ويعمل كمفعول به أول للفعل.

3- تحديد إعرابها: بناءً على الوظيفة المذكورة أعلاه، يجب أن يكون إعراب "والدي" هو المفعول به الأول (المنصوب) للفعل "أحب".

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:

الإعراب المعطى: والدي: توكيد منصوب وعلامة نصبه الكسرة.
الإعراب الصحيح: والدي: مفعول به منصوب وعلامة نصبه الفتحة.

الإجابة النهائية: خاطئ
</s><s> [INST]
        الجمله: دائما أحب والدى
        الاعراب: أحب : خبر كان منصوب وعلامة نصبه حذف النون
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة تبدو جملة فعلية لأنها تبدأ بالفعل "أحب". لكن نحتاج إلى معرفة الفاعل والمفعول به لتحديد نوعها بدقة.
2- تحديد وظيفة الكلمة: في هذه الجملة، الفاعل غير واضح (مفقود)، لكن يمكننا تحديد المفعول به وهو "والدي".
3- تحديد إعراب الكلمة:
   أ- "دائماً": ظرف زمان منصوب وعلامة نصبه الفتحة.
   ب- "أحب": فعل مضارع مرفوع وعلامة رفعه الضمة.
   ج- "والدي": مفعول به منصوب وعلامة نصبه الفتحة المقدرة لأنه اسم مقصور. والياء ضمير متصل في محل جر مضاف إليه.
4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   الإعراب المعطى يقول إن "أحب" هو خبر كان منصوب وعلامة نصبه حذف النون. لكن الجملة المعطاة لا تحتوي على كان ولا يوجد حذف لنون.
التصحيح: الجملة الصحيحة يجب أن تكون "دائماً أحب والدي" بدون ذكر "كان" وحذف النون. وإعراب "أحب" في هذه الجملة هو فعل مضارع مرفوع وعلامة رفعه الضمة الظاهرة على آخره.
الإجابة النهائية: خاطئ
</s><s> [INST]
        الجمله: دائما أحب والدى
        الاعراب: دائما : مفعول مطلق مجرور وعلامة جره الكسرة
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة هي جملة فعلية، لأنها تبدأ بالفعل "أحب".
2- تحديد وظيفة الكلمة:
   دائما: ظرف زمان منصوب وعلامة نصبه الفتحة.
   أحب: فعل مضارع مرفوع وعلامة رفعه الضمة.
   والدي: فاعل مرفوع وعلامة رفعه الضمة المقدرة وهو مضاف. والياء ضمير متصل في محل جر مضاف إليه.
3- تحديد إعرابها:
   دائما: ظرف زمان منصوب .
   أحب: فعل مضارع مرفوع.
   والدي: فاعل مرفوع.
4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   الإعراب المعطى: دائما: مفعول مطلق مجرور وعلامة جره الكسرة.
   الإعراب الصحيح: دائما: ظرف زمان منصوب وعلامة نصبه الفتحة.
بناءً على التحليل أعلاه، الإجابة النهائية هي: خاطئ.
</s><s> [INST]
        الجمله: الأولاد يلعبون في الحديقة
        الاعراب: الحديقة : حرف جر مبني على السكون
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة هي جملة فعلية، لأنها تبدأ بالفعل (يلعبون). الفعل الرئيسي هو "يلعبون" والجملة تصف حالة الأولاد وهم يلعبون.

2- تحديد وظيفة الكلمة: في هذه الجملة، الكلمة التي تحتاج إلى تحليل إعرابها هي "الحديقة". تعتبر الحديقة في هذه الجملة مفعولاً فيه (المكان الذي يجري فيه الفعل).

3- تحديد إعراب الكلمة: في الجملة "الأولاد يلعبون في الحديقة"، إعراب "الحديقة" هو:
   - الحديقة: اسم مجرور وعلامة جره الكسرة الظاهرة على آخره.

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى: الحديقة : حرف جر مبني على السكون
   - الإعراب الصحيح: الحديقة : اسم مجرور وعلامة جره الكسرة الظاهرة على آخره

بناءً على المقارنة، نجد أن الإعراب المعطى غير صحيح. الإجابة النهائية: خاطئ.
</s><s> [INST]
        الجمله: الأولاد يلعبون في الحديقة
        الاعراب: في : عطف بيان مجرور وعلامة جره الفتحة
 لنقم بتحليل الجملة خطوة بخطوة: [/INST]
 1- تحديد نوع الجملة: الجملة المعطاة هي جملة فعلية، لأنها تبدأ بالفعل (الأولاد يلعبون).

2- تحديد وظيفة الكلمة: في هذه الجملة، الكلمة المطلوب تحليلها هي "في". تعتبر "في" حرف جر.

3- تحديد إعراب "في":
   - حرف جر (في هذا السياق) يعرب حرفاً مبنياً ولا محل له من الإعراب.

4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
   - الإعراب المعطى يقول إن "في" هي عطف بيان مجرور وعلامة جره الفتحة.
   - الإعراب الصحيح لـ"في" هو حرف جر مبني على السكون ولا محل له من الإعراب.

الإجابة النهائية: خاطئ
</s>
  """
        return cot
 

    def analyze_sentence(sentence, word, irab):
        generated_response = []
        question = f"""
        الجمله: {sentence}
        الاعراب: {word} : {irab}"""        
        question = f"""
        <s> [INST] {prompt_input()}
        {question}
        لنقم بتحليل الجملة خطوة بخطوة:
        [/INST]        

        """
        final_result = model.generate_text(prompt=question, guardrails=False)
        
     
        not_correct = ['خاطئ', 'غير صحيح', 'خطأ','خطا','التصحيح']
        if any(item in final_result for item in not_correct):
         generated_response.append(0)

        elif "صحيح" in final_result:
            generated_response.append(1)
        else:
            generated_response.append(2)
        
        return generated_response[-1], final_result
    return analyze_sentence(sentence, word, irab)