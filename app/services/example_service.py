import os
import numpy as np
import pandas as pd
import pyarabic.araby as araby
from ibm_watsonx_ai.foundation_models import Model

def main(sentence, word, irab):
    print(sentence, word, irab)



    def get_credentials():
        return {
            "url": "https://eu-de.ml.cloud.ibm.com",
            "apikey": "2zpGHEYBXJAa77l8ul5Ybdyhg24eLWxm0ZG4Kwqq--Ca"
        }

    model_id = "sdaia/allam-1-13b-instruct"
    parameters = {
        "decoding_method": "greedy",
        "max_new_tokens": 900,
        "repetition_penalty": 1
    }
    project_id = '79573646-0cc6-4a79-89bc-84e719201ac1'

    model = Model(
        model_id=model_id,
        params=parameters,
        credentials=get_credentials(),
        project_id=project_id,
        space_id=None
    )

    def prompt_input():

        cot_prompt_word = """
        انت بروفيسور خبير في اللغة العربية وتستطيع اعراب اي جملة بشكل صحيح و دقيق

            المهمة: يجب عليك الان ان تتحقق مما إذا كان إعراب كلمة في جملة عربية صحيحًا.
            انت تتبع خطوات منطقية للوصول الى النتيجة النهائية
            اذا كانت الجملة خاطئة, لا تصححها! فقط اجب ب خاطئ
                            الاجابة النهائية: صحيح او خاطئ
            يجب ان نتبع الخطوات التالية لتحليل الجملة:
        1- تحديد نوع الجملة اسمية ام فعلية
        2- تحديد وظيفة الكلمة
        3- تحديد اعرابها
        4- مقارنة الاعراب المعطى مع الاعراب الصحيح


        """

        system = '<s> [INST]<<SYS>>\n' + cot_prompt_word + '<</SYS>>'

        cot_shots_prompt_word_2 = system + """
        <s> [INST]
                الجمله: ما أهملت واجبى قط
                الاعراب: ما : اسم إن منصوب وعلامة نصبه الألف
        لنقم بتحليل الجملة خطوة بخطوة: [/INST]

        1- تحديد نوع الجملة: الجملة المعطاة هي جملة اسمية، لأن الفاعل (ما) ليس اسماً لشخص أو مكان أو زمان، بل هو اسم يفيد العموم والاستغراق (اسم نكرة).

        2- تحديد وظيفة الكلمة: في هذه الجملة، الكلمة الرئيسية هي "ما" وتعني النفي.

        3- تحديد إعرابها: بناءً على نوع الجملة ووظيفة الكلمة، يمكن تحديد إعراب "ما" كالتالي:
        - ما: اسم نكرة مبني على السكون (اسم نكرة يفيد العموم والاستغراق) في محل رفع مبتدأ.

        4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
        - الإعراب المعطى: ما (اسم إن منصوب وعلامة نصبه الألف)
        - الإعراب الصحيح: ما (اسم نكرة مبني على السكون في محل رفع مبتدأ)

        الإجابة النهائية: خاطئ

        الإعراب الصحيح للجملة هو: ما (اسم نكرة مبني على السكون في محل رفع مبتدأ)، وليس "اسم إن منصوب وعلامة نصبه الألف". الجملة الاسمية هنا هي "ما أهملت واجبي قط" وتعني: أنا لم أهمل واجبي أبداً.
        </s>
        <s> [INST]
                الجمله: الطائر يطير في السماء
                الاعراب: يطير : فعل مضارع مرفوع وعلامة رفعه الضمة الظاهرة على آخره،والفاعل ضمير مستتر تقديره "هو" يعود على الطائر
        لنقم بتحليل الجملة خطوة بخطوة: [/INST]
        1- تحديد نوع الجملة: الجملة المعطاة هي جملة فعلية لأن الفعل الرئيسي فيها هو "يطير" ويتحدث عن حدوث الفعل.

        2- تحديد وظيفة الكلمة:
        - الطائر: اسم مرفوع وهو فاعل الفعل "يطير".
        - يطير: فعل مضارع مرفوع.
        - في: حرف جر.
        - السماء: اسم مجرور وعلامة جره الكسرة الظاهرة على آخره.

        3- تحديد إعراب الكلمات:
        - الطائر: فاعل مرفوع وعلامة رفعه الضمة الظاهرة على آخره.
        - يطير: فعل مضارع مرفوع وعلامة رفعه الضمة الظاهرة على آخره، والفاعل ضمير مستتر تقديره "هو".
        - في: حرف جر.
        - السماء: اسم مجرور وعلامة جره الكسرة الظاهرة على آخره.

        4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
        - الإعراب المعطى يتطابق مع الإعراب الصحيح الذي تم تحديده في الخطوة الثالثة.

        الإجابة النهائية: صحيح
        </s>

        <s> [INST]
                الجمله: الذي يفوز فله جائزة
                الاعراب: يفوز : فعل مضارع مرفوع،وعلامة رفعه الضمة الظاهرة على آخره
        لنقم بتحليل الجملة خطوة بخطوة: [/INST]
        1- تحديد نوع الجملة: الجملة المعطاة تبدو جملة فعلية لأنها تحتوي على فعل (يفوز).

        2- تحديد وظيفة الكلمة: في هذه الجملة، الفعل الرئيسي هو "يفوز" والفاعل المستتر تقديره "هو".

        3- تحديد إعراب الكلمة:
        - يفوز: فعل مضارع مرفوع، وعلامة رفعه الضمة الظاهرة على آخره. (هذا الإعراب المعطى)

        4- مقارنة الإعراب المعطى مع الإعراب الصحيح:
        - الإعراب المعطى: يفوز (فعل مضارع مرفوع، وعلامة رفعه الضمة الظاهرة على آخره)
        - الإعراب الصحيح: يفوز (فعل مضارع مرفوع، وعلامة رفعه الضمة الظاهرة على آخره)

        بناءً على المقارنة، يتطابق الإعراب المعطى مع الإعراب الصحيح.

        الإجابة النهائية: صحيح
        </s>
        """
        return cot_shots_prompt_word_2
 
    def analyze_sentence(sentence, word, irab):
        generated_response = []
        question = f"""
        الجمله: {sentence}
        الاعراب: {word} : {irab}"""        
        question = question + "\n لنقم بتحليل الجملة خطوة بخطوة:"
        question = f"""<s> [INST] {question} [/INST]"""
        prompt = f"""{prompt_input()}{question}"""
        final_result = model.generate_text(prompt=prompt, guardrails=False)
        
     
        not_correct = ['خاطئ', 'غير صحيح', 'خطأ','خطا','التصحيح']
        if any(item in final_result for item in not_correct):
         generated_response.append(0)

        elif "صحيح" in final_result:
            generated_response.append(1)
        else:
            generated_response.append(2)
        
        return generated_response[-1], final_result
    return analyze_sentence(sentence, word, irab)